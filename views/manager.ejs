<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<%- include('components/header') %>
<div class="container mt-4">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title" data-i18n="personal-info"></h5>
            <p class="card-text" data-i18n="surname"><span id="surname"></span></p>
            <p class="card-text" data-i18n="name"><span id="name"></span></p>
            <p class="card-text" data-i18n="lastname"><span id="lastname"></span></p>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title" data-i18n="class-schedule"></h5>
            <div class="row mb-3">
                <div class="col-md-1 mb-1">
                    <select id="classSelect" class="form-select" aria-label="Select Class"></select>
                </div>
                <div class="col mx-auto">
                    <select id="yearSelect" class="form-select" aria-label="Select Year"></select>
                </div>
                <div class="col mx-auto">
                    <select id="monthSelect" class="form-select" aria-label="Select Month">
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4" id="classInfoCard" style="display: none">
        <div class="card-body">
            <h5 class="card-title" data-i18n="class-info"></h5>
            <p class="card-text" data-i18n="class-name"><span id="className"></span></p>
            <p class="card-text" data-i18n="number-of-lessons"><span id="numberOfLessons"></span></p>
            <p class="card-text" data-i18n="lesson-days"><span id="lessonDays"></span></p>
            <p class="card-text" data-i18n="teacher"><span id="teacher"></span></p>
            <h5 class="card-title mt-3" data-i18n="students"></h5>
            <ul id="studentsList"></ul>
            <div id="studentDetails"></div>

        </div>
    </div>
</div>
<script src="/i18n.js"></script>

<script>
    function fetchManagerDataAndRenderCalendar() {
        const url = window.location.href
        const {managerId} = extractIdsFromUrl(url)

        const classSelect = document.getElementById('classSelect')
        classSelect.innerHTML = '<option value="" selected disabled data-i18n="select-class"></option>'

        const yearSelect = document.getElementById('yearSelect')
        yearSelect.innerHTML = '<option value="" selected disabled data-i18n="select-year"></option>'

        const monthSelect = document.getElementById('monthSelect')
        monthSelect.innerHTML = '<option value="" selected disabled data-i18n="select-month"></option>'

        axios.get(`http://localhost:3000/api/manager/${managerId}`)
            .then(function (response) {
                const manager = response.data.manager
                console.log(manager.surname)
                console.log(response.data)
                document.getElementById('surname').innerText = manager.surname
                document.getElementById('name').innerText = manager.name
                document.getElementById('lastname').innerText = manager.lastname

                const managerClasses = manager.classes
                managerClasses.forEach(cls => {
                    const option = document.createElement('option')
                    option.value = cls._id
                    option.innerText = cls.name
                    classSelect.appendChild(option)
                })

                const yearsAndMonths = getUniqueYearsAndMonthsForManager(managerClasses)
                renderYearAndMonthSelect(yearsAndMonths)
            })
            .catch(function (error) {
                console.error('Error fetching manager data:', error)
            })
    }

    function getUniqueYearsAndMonthsForManager(classes) {
        const yearsAndMonths = {}
        classes.forEach(cls => {
            cls.schedule.forEach(scheduleItem => {
                if (!yearsAndMonths[scheduleItem.year]) {
                    yearsAndMonths[scheduleItem.year] = []
                }
                if (!yearsAndMonths[scheduleItem.year].includes(scheduleItem.month)) {
                    yearsAndMonths[scheduleItem.year].push(scheduleItem.month)
                }
            })
        })
        return yearsAndMonths
    }

    function renderYearAndMonthSelect(yearsAndMonths) {
        const yearSelect = document.getElementById('yearSelect')
        yearSelect.innerHTML = '<option value="" selected disabled data-i18n="select-year"></option>'
        Object.keys(yearsAndMonths).forEach(year => {
            const option = document.createElement('option')
            option.value = year
            option.innerText = year
            yearSelect.appendChild(option)
        })
        yearSelect.addEventListener('change', function (event) {
            const selectedYear = event.target.value
            const monthSelect = document.getElementById('monthSelect')
            monthSelect.innerHTML = '<option value="" selected disabled data-i18n="select-month"></option>'
            if (selectedYear) {
                yearsAndMonths[selectedYear].forEach(month => {
                    const option = document.createElement('option')
                    option.value = month
                    option.innerText = getMonthName(month)
                    monthSelect.appendChild(option)
                })
            }
        })
    }

    document.getElementById('classSelect').addEventListener('change', function (event) {
        const selectedClassId = event.target.value
        const selectedYear = document.getElementById('yearSelect').value
        const selectedMonth = document.getElementById('monthSelect').value

        fetchClassInfo(selectedClassId, selectedYear, selectedMonth)
    })

    document.getElementById('yearSelect').addEventListener('change', function (event) {
        const selectedYear = event.target.value
        const selectedMonth = document.getElementById('monthSelect').value
        const selectedClassId = document.getElementById('classSelect').value

        fetchClassInfo(selectedClassId, selectedYear, selectedMonth)
    })

    document.getElementById('monthSelect').addEventListener('change', function (event) {
        const selectedMonth = event.target.value
        const selectedYear = document.getElementById('yearSelect').value
        const selectedClassId = document.getElementById('classSelect').value

        fetchClassInfo(selectedClassId, selectedYear, selectedMonth)
    })

    function fetchClassInfo(classId, year, month) {
        axios.get(`http://localhost:3000/api/manager/class/${classId}`)
            .then(function (response) {
                const classInfo = response.data.classInfo
                const selectedSchedule = classInfo.schedule.find(schedule => schedule.year == year && schedule.month == month)
                if (selectedSchedule) {
                    let lastSelectedItem = null
                    document.getElementById('className').innerText = classInfo.name
                    document.getElementById('numberOfLessons').innerText = selectedSchedule.numberOfLessons
                    document.getElementById('lessonDays').innerText = selectedSchedule.lessonDays
                    document.getElementById('teacher').innerText = `${classInfo.teacher.surname} ${classInfo.teacher.name} ${classInfo.teacher.lastname}`
                    const studentsList = document.getElementById('studentsList')
                    studentsList.innerHTML = ''

                    classInfo.students.forEach(student => {
                        const listItem = document.createElement('li')
                        const lessonsCount = student.lessons.filter(lesson => lesson.month == month).length
                        const paymentForMonth = student.payments.find(payment => payment.year == year && payment.month == month)
                        const daysAttended = student.lessons.filter(lesson => lesson.month == month && lesson.year == year).map(lesson => lesson.day)

                        listItem.innerText = `${student.surname} ${student.name.charAt(0)}. ${student.lastname.charAt(0)}. - ${lessonsCount}/${selectedSchedule.numberOfLessons}`
                        listItem.classList.add('student-item')
                        listItem.style.color = 'blue'
                        listItem.style.textDecoration = 'underline'

                        const payButton = document.createElement('button')
                        payButton.innerText = 'Pay'
                        payButton.classList.add('btn', 'btn-primary', 'mb-1')

                        const space = document.createElement('span')
                        space.innerText = ' '

                        listItem.addEventListener('click', () => {
                            if (lastSelectedItem) {
                                lastSelectedItem.style.color = 'blue'
                            }
                            listItem.style.color = 'red'
                            lastSelectedItem = listItem
                            displayStudentDetails(student, lessonsCount, paymentForMonth, daysAttended, month, year, selectedSchedule)
                        })
                        if (paymentForMonth && paymentForMonth.payment === true) {
                            payButton.style.display = 'none'
                        } else {
                            payButton.addEventListener('click', (event) => {
                                event.stopPropagation()
                                axios.post(`http://localhost:3000/api/manager/${student._id}/${year}/${month}`)
                                    .then(response => {
                                        window.location.reload()
                                    })
                                    .catch(err => {
                                        console.log(err)
                                    })
                            })
                        }
                        listItem.appendChild(space)
                        listItem.appendChild(payButton)
                        studentsList.appendChild(listItem)
                    })
                    document.getElementById('classInfoCard').style.display = 'block'
                } else {
                    document.getElementById('classInfoCard').style.display = 'none'
                }
            })
            .catch(function (error) {
                console.error('Error fetching class info:', error)
            })
    }

    function displayStudentDetails(student, lessonsCount, paymentForMonth, daysAttended, month, year, selectedSchedule) {
        const studentDetails = document.getElementById('studentDetails')
        studentDetails.innerHTML = `
        <h5 data-i18n="student-details"></h5>
        <p data-i18n="full-name">${student.surname} ${student.name} ${student.lastname}</p>
        <p data-i18n="lessons-attended">${lessonsCount}/${selectedSchedule.numberOfLessons}</p>
        <p data-i18n="days-attended">${daysAttended.join(', ')}</p>
        <p data-i18n="payment">${paymentForMonth ? paymentForMonth.payment : 'false'}</p>
    `
    }

    function extractIdsFromUrl(url) {
        const segments = url.split('/')
        const managerId = segments[5]
        return {managerId}
    }

    function getMonthName(month) {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
        return monthNames[month - 1] || ''
    }

    // function getMonthName(month) {
    //     return i18n[currentLanguage].months[month - 1] || ''
    // }

    document.addEventListener('DOMContentLoaded', () => {
        fetchManagerDataAndRenderCalendar()
    })

</script>


</body>
</html>
