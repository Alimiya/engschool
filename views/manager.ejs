<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<div class="container mt-4">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Personal Info</h5>
            <p class="card-text">Surname: <span id="surname"></span></p>
            <p class="card-text">Name: <span id="name"></span></p>
            <p class="card-text">Lastname: <span id="lastname"></span></p>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Class Schedule</h5>
            <div class="row mb-3">
                <div class="col-md-1 mb-1">
                    <select id="classSelect" class="form-select" aria-label="Select Class"></select>
                </div>
                <div class="col mx-auto">
                    <select id="yearSelect" class="form-select" aria-label="Select Year"></select>
                </div>
                <div class="col mx-auto">
                    <select id="monthSelect" class="form-select" aria-label="Select Month">
                    </select>
                </div>
                <div class="col w-60">
                    <button id="searchButton" class="btn btn-primary">Search</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4" id="classInfoCard" style="display: none">
        <div class="card-body">
            <h5 class="card-title">Class Info</h5>
            <p class="card-text">Class Name: <span id="className"></span></p>
            <p class="card-text">Selected Lesson Days: <span id="lessonDays"></span></p>
            <p class="card-text">Teacher: <span id="teacher"></span></p>
            <div id="studentsList" class="mt-3">
            </div>
        </div>
    </div>
</div>

<script>
    async function getManager(){
        const url = window.location.href
        const {managerId} = extractIdsFromUrl(url)
        await axios.get(`http://localhost:3000/api/manager/${managerId}`)
            .then(response => {
                const managerData = response.data.manager
                fillManagerAndClasses(managerData)
            })
            .catch(error => console.error('Error:', error))
    }

    function fillManagerAndClasses(managerData) {
        document.getElementById('surname').innerText = managerData.surname
        document.getElementById('name').innerText = managerData.name
        document.getElementById('lastname').innerText = managerData.lastname

        const classSelect = document.getElementById('classSelect')
        managerData.classes.forEach(classInfo => {
            const option = document.createElement('option')
            option.value = classInfo._id
            option.textContent = classInfo.name
            classSelect.appendChild(option)
        })
        const yearSelect = document.getElementById('yearSelect')
        managerData.classes.forEach(classInfo => {
            const option = document.createElement('option')
            option.value = classInfo.schedule._id
            option.textContent = classInfo.schedule.year
            yearSelect.appendChild(option)
        })
        const monthSelect = document.getElementById('monthSelect')
        managerData.classes.forEach(classInfo => {
            const option = document.createElement('option')
            option.value = classInfo.schedule._id
            option.textContent = classInfo.schedule.month
            monthSelect.appendChild(option)
        })
        classSelect.addEventListener('change', getClassInfo)
    }

    function showClassInfo(classInfo) {
        document.getElementById('className').innerText = classInfo.name
        document.getElementById('lessonDays').innerText = classInfo.schedule.selectedLessonDays
        const fullName = `${classInfo.teacher.surname} ${classInfo.teacher.name} ${classInfo.teacher.lastname}`
        document.getElementById('teacher').innerText = fullName

        const studentsList = document.getElementById('studentsList')
        studentsList.innerHTML = ''

        const students = classInfo.students
        students.forEach(student => {
            const listItem = document.createElement('div')
            listItem.className = 'mb-2'
            listItem.innerHTML = `
                <strong>${student.surname} ${student.name} ${student.lastname} 0/12</strong>
                (Payment: ${(!!student.payment)})
            `
            studentsList.appendChild(listItem)
        })

        document.getElementById('classInfoCard').style.display = 'block'
    }

    function getClassInfo() {
        const classSelect = document.getElementById('classSelect')
        console.log(classSelect)
        const classId = '65c5d62887def68d1738a0f3'

        axios.get(`http://localhost:3000/api/manager/class/${classId}`)
            .then(response => {
                const classInfo = response.data.classInfo
                console.log(classInfo)
                showClassInfo(classInfo)
            })
            .catch(error => console.error('Error:', error))
    }
    document.getElementById('classSelect').addEventListener('change', getClassInfo)


    function extractIdsFromUrl(url) {
        const segments = url.split("/")
        const managerId = segments[5]
        return { managerId}
    }

    document.addEventListener('DOMContentLoaded', () => {
        getManager()
        getClassInfo()
    })
</script>


</body>
</html>
